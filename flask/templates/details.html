{% extends "default_page.html" %}
{% block content %}
<link rel="icon" type="image/png" href="static/images/saga_scroll.webp">

<main class="container py-4 bg-body-tertiary">
    {% if "username" in session %}
    <div class="card bg-dark mb-3 mx-auto" style="max-width: 100rem;">
        <div class="card mb-3">
            <img src="{{ url_for('static', filename='images/' + novel.cover_image) }}"
                class="rounded-circle d-block mx-auto mt-3" alt="Book Cover" style="width: 200px; height: 200px;">
            <div class="card-body">
                <h2 class="card-title text-center"><strong>{{ novel.novel_title }}</strong></h2>
                <p class="card-text text-muted">Description: <i>{{ novel.description }}</i></p>
                <p class="card-text text-muted">Genre: <i>{{ novel.genre }}</i></p>
                <p class="card-text text-muted">Theme: <i>{{ novel.theme }}</i></p>
                <p class="card-text"><small class="text-muted">{{ novel.publish_date }}</small></p>

                <button class="btn btn-outline-warning save-btn" data-novel-id="{{ novel.novel_id }}">
                    ðŸ“š Save to Booklist
                </button>

                <!-- Chapter Section -->
                {% if chapter %}
                <div class="chapter-content mt-4" id="chapterText">
                    <h3 class="text-center" id="chapterTitle">{{ chapter.chapter_name }}</h3>
                    <p id="chapterContent">{{ chapter.content }}</p>

                    <div class="d-flex justify-content-between">
                        <button id="previousBtn" class="btn btn-secondary"
                            data-previous-id="{{ chapter.chapter_number - 1 }}">Previous</button>
                        <button id="nextBtn" class="btn btn-primary"
                            data-next-id="{{ chapter.chapter_number + 1 }}">Next</button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="container mt-5">
        <h3 style="background-color:  #8b5a2b; border-radius: 10px;">Reviews & Comments</h3>
        {% if reviews %}
        <div class="reviews-container">
            {% for review in reviews %}
            <div class="review mb-4 p-3 bg-light rounded">
                <div class="d-flex align-items-center mb-1">
                    <img src="{{ url_for('static', filename='images/' + review.profile_photo) }}" alt="Profile Photo"
                        class="rounded-circle me-2" style="width: 40px; height: 40px;">
                    <strong>{{ review.username }}</strong>
                </div>
                <p class="mb-1">{{ review.review_text }}</p>
                <p class="mb-0"><sub class="text-muted">{{ review.publish_time }}</sub></p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No reviews yet. Be the first to comment!</p>
        {% endif %}

        <!-- Comment Form -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Add a Comment</h5>
                <form method="POST">
                    <div class="form-group">
                        <label for="content">Your Comment:</label>
                        <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary mt-2">Post Comment</button>
                </form>
            </div>
        </div>
    </div>

    {% else %}
    <p>
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
        to read the novel and add a comment.
    </p>
    {% endif %}
</main>

<!-- Optional Bootstrap JS (only if not in base template) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.querySelectorAll(".save-btn").forEach(button => {
        button.addEventListener("click", () => {
            const novelId = button.getAttribute("data-novel-id");

            fetch(`/save_novel/${novelId}`, { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "saved") {
                        button.textContent = "âœ… Add to Booklist";
                        button.classList.remove("btn-outline-warning");
                        button.classList.add("btn-success");
                    }
                });
        });
    });
    const chapterTitle = document.getElementById('chapterTitle');
    const chapterText = document.getElementById('chapterContent');
    const previousBtn = document.getElementById('previousBtn');
    const nextBtn = document.getElementById('nextBtn');

    let currentChapterId = parseInt(`{{ chapter.chapter_number }}`);
    const novelId = parseInt(`{{ novel.novel_id }}`);

    // Define this function BEFORE it's called in loadChapter
    function formatChapterContent(content) {
        return content.split('\n').map(line => `<p>${line.trim()}</p>`).join('');
    }

    function loadChapter(chapterId) {
        fetch(`/chapter/${novelId}/${chapterId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                chapterTitle.textContent = data.chapter_name;
                chapterText.innerHTML = formatChapterContent(data.content); // <-- now it works!
                currentChapterId = chapterId;

                if (data.previous_id !== null) {
                    previousBtn.style.display = 'inline-block';
                    previousBtn.setAttribute("data-previous-id", data.previous_id);
                } else {
                    previousBtn.style.display = 'none';
                }

                if (data.next_id !== null) {
                    nextBtn.style.display = 'inline-block';
                    nextBtn.setAttribute("data-next-id", data.next_id);
                } else {
                    nextBtn.style.display = 'none';
                }
            });
    }

    previousBtn.addEventListener("click", () => {
        const prevId = previousBtn.getAttribute("data-previous-id");
        if (prevId) loadChapter(prevId);
    });

    nextBtn.addEventListener("click", () => {
        const nextId = nextBtn.getAttribute("data-next-id");
        if (nextId) loadChapter(nextId);
    });

    // Kick things off
    loadChapter(currentChapterId);
</script>
<style>
    .chapter-content {
        background-color: #fdfcfb;
        padding: 20px;
        border-radius: 12px;
        margin: 20px auto;
        max-width: 800px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        line-height: 1.8;
        font-family: 'Georgia', serif;
    }

    .chapter-content h3 {
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
        color: #4b2e83;
    }

    .chapter-content p {
        text-indent: 2em;
        margin-bottom: 1em;
        font-size: 1.05em;
        color: #1f1f1f;
    }
</style>

{% endblock %}